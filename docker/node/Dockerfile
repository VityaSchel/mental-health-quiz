# syntax=docker/dockerfile:1
FROM node:16.14.0-alpine as install

WORKDIR /app

#COPY node_modules node_modules
COPY .npmrc .npmrc
COPY package.json package.json
COPY yarn.lock yarn.lock

RUN yarn install --check-files
RUN rm -r .npmrc

FROM node:16.13.0-alpine as builder

ARG NEXT_PUBLIC_BACKEND_URL
ARG NEXT_PUBLIC_DATA_POLICY
ARG NEXT_PUBLIC_TARIFFS
ARG NEXT_PUBLIC_USER_AGREEMENT
ARG NEXT_PUBLIC_CONTACT_EMAIL
ARG NEXT_PUBLIC_COMPANY_NAME
ARG NEXT_PUBLIC_COMPANY_INN
ARG NEXT_PUBLIC_COMPANY_OGRNIP
ARG NEXT_PUBLIC_YANDEX_METRIC_ID
ARG NEXT_PUBLIC_YANDEX_METRIC_GOAL_PAY_BEFORE_CHECKBOXES
ARG NEXT_PUBLIC_YANDEX_METRIC_GOAL_PAY_AFTER_CHECKBOXES
ARG NEXT_PUBLIC_VK_METRIC_HOMEPAGE
ARG NEXT_PUBLIC_VK_METRIC_RESULT

WORKDIR /app

COPY . .

RUN echo NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL >> .env.local && \
    echo NEXT_PUBLIC_DATA_POLICY=$NEXT_PUBLIC_DATA_POLICY >> .env.local && \
    echo NEXT_PUBLIC_TARIFFS=$NEXT_PUBLIC_TARIFFS >> .env.local && \
    echo NEXT_PUBLIC_USER_AGREEMENT=$NEXT_PUBLIC_USER_AGREEMENT >> .env.local && \
    echo NEXT_PUBLIC_CONTACT_EMAIL=$NEXT_PUBLIC_CONTACT_EMAIL >> .env.local && \
    echo NEXT_PUBLIC_COMPANY_NAME=$NEXT_PUBLIC_COMPANY_NAME >> .env.local && \
    echo NEXT_PUBLIC_COMPANY_INN=$NEXT_PUBLIC_COMPANY_INN >> .env.local && \
    echo NEXT_PUBLIC_COMPANY_OGRNIP=$NEXT_PUBLIC_COMPANY_OGRNIP >> .env.local && \
    echo NEXT_PUBLIC_YANDEX_METRIC_ID=$NEXT_PUBLIC_YANDEX_METRIC_ID >> .env.local && \
    echo NEXT_PUBLIC_YANDEX_METRIC_GOAL_PAY_BEFORE_CHECKBOXES=$NEXT_PUBLIC_YANDEX_METRIC_GOAL_PAY_BEFORE_CHECKBOXES >> .env.local && \
    echo NEXT_PUBLIC_YANDEX_METRIC_GOAL_PAY_AFTER_CHECKBOXES=$NEXT_PUBLIC_YANDEX_METRIC_GOAL_PAY_AFTER_CHECKBOXES >> .env.local && \
    echo NEXT_PUBLIC_VK_METRIC_HOMEPAGE=$NEXT_PUBLIC_VK_METRIC_HOMEPAGE >> .env.local && \
    echo NEXT_PUBLIC_VK_METRIC_RESULT=$NEXT_PUBLIC_VK_METRIC_RESULT >> .env.local

RUN yarn build

CMD ["yarn", "start"]
