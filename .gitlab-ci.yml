stages:
  - prepare
  - build
  - deploy

image: docker:${DOCKER_VERSION}
variables:
  DOCKER_BUILDKIT: 1
  DOCKER_VERSION: 20.10.17

.docker_init_template:
  - docker login -u $DOCKER_REGISTRY_USER -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY

.ssh_init_template:
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - chmod 700 ~/.ssh
  - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts
  - eval $(ssh-agent -s)
  - ssh-add ~/.ssh/id_rsa

install:
  stage: prepare
  services:
    - name: docker:${DOCKER_VERSION}-dind
      command: ["--registry-mirror", "https://proxy-registry.skidstor.com"]
  cache:
    - key:
        files:
          - yarn.lock
      paths:
        - node_modules
      policy: pull-push
  before_script:
    - !reference [.docker_init_template]
  script:
    - mkdir -p node_modules

    - >
      docker build
      --file docker/node/Dockerfile
      --target install
      --tag $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-install
      .

    - rm -rf node_modules

    - docker create --name node $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-install
    - docker cp node:/app/node_modules $CI_PROJECT_DIR/

.build_production_template:
  stage: build
  services:
    - name: docker:${DOCKER_VERSION}-dind
      command: ["--registry-mirror", "https://proxy-registry.skidstor.com"]
  cache:
    - key:
        files:
          - yarn.lock
      paths:
        - node_modules
      policy: pull
    - key: next-cache-${PROJECT_NAME}-${CI_COMMIT_REF_SLUG}
      paths:
        - .next/cache
      policy: pull-push
  before_script:
    - !reference [.docker_init_template]
  script:
    - mkdir -p .next/cache

    - >
      docker build
      --file docker/node/Dockerfile
      --build-arg BUILDKIT_INLINE_CACHE=1
      --cache-from $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-$PROJECT_NAME
      --target builder
      --tag $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-$PROJECT_NAME
      --build-arg NEXT_PUBLIC_BACKEND_URL="$NEXT_PUBLIC_BACKEND_URL"
      --build-arg NEXT_PUBLIC_DATA_POLICY="$NEXT_PUBLIC_DATA_POLICY"
      --build-arg NEXT_PUBLIC_TARIFFS="$NEXT_PUBLIC_TARIFFS"
      --build-arg NEXT_PUBLIC_USER_AGREEMENT="$NEXT_PUBLIC_USER_AGREEMENT"
      --build-arg NEXT_PUBLIC_CONTACT_EMAIL="$NEXT_PUBLIC_CONTACT_EMAIL"
      --build-arg NEXT_PUBLIC_COMPANY_NAME="$NEXT_PUBLIC_COMPANY_NAME"
      --build-arg NEXT_PUBLIC_COMPANY_INN="$NEXT_PUBLIC_COMPANY_INN"
      --build-arg NEXT_PUBLIC_COMPANY_OGRNIP="$NEXT_PUBLIC_COMPANY_OGRNIP"
      --build-arg NEXT_PUBLIC_METRICA_HOMEPAGE="$NEXT_PUBLIC_METRICA_HOMEPAGE"
      --build-arg NEXT_PUBLIC_METRICA_RESULTS_PAGE="$NEXT_PUBLIC_METRICA_RESULTS_PAGE"
      --build-arg NEXT_PUBLIC_METRICA_PAY_MODAL="$NEXT_PUBLIC_METRICA_PAY_MODAL"
      .

    - rm -rf .next/cache

    - docker create --name quiz $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-$PROJECT_NAME
    - docker cp quiz:/app/.next/cache $CI_PROJECT_DIR/.next/cache

    - docker push $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-$PROJECT_NAME
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

.deploy_production_template:
  stage: deploy
  environment:
    name: production-${PROJECT_NAME}
  variables:
    COMPOSE_PROJECT_NAME: ${PROJECT_NAME}_quiz
    LANDING_IMAGE: $DOCKER_REGISTRY_PATH:$CI_COMMIT_REF_NAME-$PROJECT_NAME
    DOCKER_HOST: $DEPLOY_PROD_DOCKER_HOST
  before_script:
    - !reference [.ssh_init_template]
    - !reference [.docker_init_template]
  script:
    - docker compose pull frontend

    - docker compose up -d --wait
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

build_cleanmindpro:
  extends: .build_production_template
  variables:
    PROJECT_NAME: cleanmindpro
    NEXT_PUBLIC_BACKEND_URL: https://api.cleanmind.pro
    NEXT_PUBLIC_DATA_POLICY: https://example.org
    NEXT_PUBLIC_TARIFFS: https://example.org
    NEXT_PUBLIC_USER_AGREEMENT: https://example.org
    NEXT_PUBLIC_CONTACT_EMAIL: promohelper@proton.me
    NEXT_PUBLIC_COMPANY_NAME: ИП Круковский Андрей Николаевич
    NEXT_PUBLIC_COMPANY_OGRNIP: 322784700279882
    NEXT_PUBLIC_METRICA_HOMEPAGE: <script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src='https://vk.com/js/api/openapi.js?169',t.onload=function(){VK.Retargeting.Init("VK-RTRG-1753721-6774X"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><noscript><img src="https://vk.com/rtrg?p=VK-RTRG-1753721-6774X" style="position:fixed; left:-999px;" alt=""/></noscript>
    NEXT_PUBLIC_METRICA_RESULTS_PAGE: <script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src='https://vk.com/js/api/openapi.js?169',t.onload=function(){VK.Retargeting.Init("VK-RTRG-1753716-br2Vp"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><noscript><img src="https://vk.com/rtrg?p=VK-RTRG-1753716-br2Vp" style="position:fixed; left:-999px;" alt=""/></noscript>
    NEXT_PUBLIC_METRICA_PAY_MODAL: <script type="text/javascript">!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src='https://vk.com/js/api/openapi.js?169',t.onload=function(){VK.Retargeting.Init("VK-RTRG-1753697-gaHYj"),VK.Retargeting.Hit()},document.head.appendChild(t)}();</script><noscript><img src="https://vk.com/rtrg?p=VK-RTRG-1753697-gaHYj" style="position:fixed; left:-999px;" alt=""/></noscript>

deploy_production_cleanmindpro:
  extends: .deploy_production_template
  variables:
    PROJECT_NAME: cleanmindpro
    VIRTUAL_HOST: cleanmind.pro
